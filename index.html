<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>AWS Chime Basic Example</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    button {
      margin-right: 10px;
      padding: 10px 20px;
      cursor: pointer;
    }
    video {
      display: block;
      margin-top: 20px;
      background-color: #000;
      width: 600px;
      height: 400px;
    }
  </style>
</head>
<body>
  <h1>AWS Chime Video Call (Basic)</h1>
  <button id="createMeetingBtn">Create Meeting</button>
  <button id="joinMeetingBtn">Join Meeting</button>
  <button id="shareScreenBtn">Share Screen</button>
  <video id="video" autoplay playsinline></video>
  <script src="https://unpkg.com/amazon-chime-sdk-js@latest"></script>
  <script>
    const CREATE_MEETING_URL = 'https://zwet6r6or1.execute-api.us-east-1.amazonaws.com/create-meeting';
    let meetingData = null;
    let meetingSession = null;

    document.getElementById('createMeetingBtn').addEventListener('click', async () => {
      try {
        const response = await fetch(CREATE_MEETING_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        if (!response.ok) {
          throw new Error('Failed to create meeting');
        }
        meetingData = await response.json();
        console.log('Meeting created:', meetingData);
        alert('Meeting created successfully!');
      } catch (error) {
        console.error(error);
        alert('Error creating meeting');
      }
    });

    document.getElementById('joinMeetingBtn').addEventListener('click', async () => {
      try {
        if (!meetingData) {
          alert('Please create a meeting first.');
          return;
        }
        const { meeting, attendee } = meetingData;
        const logger = new ChimeSDK.ConsoleLogger('ChimeSDK', ChimeSDK.LogLevel.INFO);
        const deviceController = new ChimeSDK.DefaultDeviceController(logger);
        const configuration = new ChimeSDK.MeetingSessionConfiguration(meeting, attendee);
        meetingSession = new ChimeSDK.DefaultMeetingSession(configuration, logger, deviceController);
        const audioInputDevices = await deviceController.listAudioInputDevices();
        if (audioInputDevices.length > 0) {
          await deviceController.chooseAudioInputDevice(audioInputDevices[0].deviceId);
        }
        const videoInputDevices = await deviceController.listVideoInputDevices();
        if (videoInputDevices.length > 0) {
          await meetingSession.audioVideo.chooseVideoInputDevice(videoInputDevices[0].deviceId);
        }
        meetingSession.audioVideo.start();
        meetingSession.audioVideo.startLocalVideoTile();
        meetingSession.audioVideo.addObserver({
          videoTileDidUpdate: tileState => {
            if (!tileState.boundAttendeeId) {
              return;
            }
            const tileId = tileState.tileId;
            meetingSession.audioVideo.bindVideoElement(
              tileId,
              document.getElementById('video')
            );
          }
        });
        alert('Joined meeting successfully!');
      } catch (error) {
        console.error(error);
        alert('Error joining meeting');
      }
    });

    document.getElementById('shareScreenBtn').addEventListener('click', async () => {
      try {
        if (!meetingSession) {
          alert('Join the meeting before sharing your screen.');
          return;
        }
        const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
        meetingSession.audioVideo.startContentShare(screenStream);
        alert('Screen sharing started!');
      } catch (error) {
        console.error(error);
        alert('Error starting screen share');
      }
    });
  </script>
</body>
</html>
